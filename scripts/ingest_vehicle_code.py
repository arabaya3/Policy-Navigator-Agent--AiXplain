import requests
from bs4 import BeautifulSoup
import time
from aixplain.factories import IndexFactory
from aixplain.modules.model.record import Record
from dotenv import load_dotenv
load_dotenv()
SECTIONS = ["100", "101", "4000", "4001", "4002", "21000", "21001", "38750", "38751", "42000", "42001", "22350", "12500", "22500", "23123", "23152", "27315", "34500", "34680", "38000", "40000.1", "42000", "42001", "42002", "42003", "42004", "42005", "42006", "42007", "42008", "42009", "42010", "42011", "42012", "42013", "42014", "42015", "42016", "42017", "42018", "42019", "42020", "42021", "42022", "42023", "42024", "42025", "42026", "42027", "42028", "42029", "42030", "42031", "42032", "42033", "42034", "42035", "42036", "42037", "42038", "42039", "42040", "42041", "42042", "42043", "42044", "42045", "42046", "42047", "42048", "42049", "42050", "42051", "42052", "42053", "42054", "42055", "42056", "42057", "42058", "42059", "42060", "42061", "42062", "42063", "42064", "42065", "42066", "42067", "42068", "42069", "42070", "42071", "42072", "42073", "42074", "42075", "42076", "42077", "42078", "42079", "42080", "42081", "42082", "42083", "42084", "42085", "42086", "42087", "42088", "42089", "42090", "42091", "42092", "42093", "42094", "42095", "42096", "42097", "42098", "42099", "42100", "42101", "42102", "42103", "42104", "42105", "42106", "42107", "42108", "42109", "42110", "42111", "42112", "42113", "42114", "42115", "42116", "42117", "42118", "42119", "42120", "42121", "42122", "42123", "42124", "42125", "42126", "42127", "42128", "42129", "42130", "42131", "42132", "42133", "42134", "42135", "42136", "42137", "42138", "42139", "42140", "42141", "42142", "42143", "42144", "42145", "42146", "42147", "42148", "42149", "42150", "42151", "42152", "42153", "42154", "42155", "42156", "42157", "42158", "42159", "42160", "42161", "42162", "42163", "42164", "42165", "42166", "42167", "42168", "42169", "42170", "42171", "42172", "42173", "42174", "42175", "42176", "42177", "42178", "42179", "42180", "42181", "42182", "42183", "42184", "42185", "42186", "42187", "42188", "42189", "42190", "42191", "42192", "42193", "42194", "42195", "42196", "42197", "42198", "42199", "42200", "42201", "42202", "42203", "42204", "42205", "42206", "42207", "42208", "42209", "42210", "42211", "42212", "42213", "42214", "42215", "42216", "42217", "42218", "42219", "42220", "42221", "42222", "42223", "42224", "42225", "42226", "42227", "42228", "42229", "42230", "42231", "42232", "42233", "42234", "42235", "42236", "42237", "42238", "42239", "42240", "42241", "42242", "42243", "42244", "42245", "42246", "42247", "42248", "42249", "42250", "42251", "42252", "42253", "42254", "42255", "42256", "42257", "42258", "42259", "42260", "42261", "42262", "42263", "42264", "42265", "42266", "42267", "42268", "42269", "42270", "42271", "42272", "42273", "42274", "42275", "42276", "42277"]
BASE_URL = "https://leginfo.legislature.ca.gov/faces/codes_displaySection.xhtml?lawCode=VEH&sectionNum={}"
INDEX_NAME = "Vehicle Code Index"
INDEX_DESC = "California Vehicle Code sections scraped from the official website."
def fetch_section(section_num):
    url = BASE_URL.format(section_num)
    resp = requests.get(url)
    if resp.status_code != 200:
        return None
    soup = BeautifulSoup(resp.text, "html.parser")
    title = soup.find("h3")
    title = title.text.strip() if title else f"Section {section_num}"
    content = soup.find("div", {"class": "section"})
    text = content.text.strip() if content else ""
    return {"section": section_num, "title": title, "text": text}
def main():
    try:
        index = IndexFactory.create(name=INDEX_NAME, description=INDEX_DESC)
    except Exception as e:
        print(f"Index may already exist: {e}")
        from aixplain.factories import IndexFactory as IF
        index = IF.get_by_name(INDEX_NAME)
    for sec in SECTIONS:
        print(f"Fetching section {sec}...")
        entry = fetch_section(sec)
        if entry and entry['text']:
            rec = Record(
                value=entry['text'],
                attributes={"section": entry['section'], "title": entry['title']}
            )
            index.upsert([rec])
        time.sleep(0.5)
    print(f"Upserted all sections to aiXplain index '{INDEX_NAME}'")
if __name__ == "__main__":
    main() 